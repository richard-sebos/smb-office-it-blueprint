---
################################################################################
# Role: user_config
# Purpose: Configure admin user and sudo access
################################################################################

- name: Ensure admin user exists
  user:
    name: "{{ admin_user.username }}"
    groups: "{{ admin_user.groups }}"
    shell: "{{ admin_user.shell }}"
    append: yes

- name: Configure sudo access
  lineinfile:
    path: /etc/sudoers.d/{{ admin_user.username }}
    line: "{{ admin_user.username }} ALL=(ALL) NOPASSWD:ALL"
    create: yes
    validate: 'visudo -cf %s'
    mode: '0440'

- name: Ensure .ssh directory exists for admin user
  file:
    path: /home/{{ admin_user.username }}/.ssh
    state: directory
    owner: "{{ admin_user.username }}"
    group: "{{ admin_user.username }}"
    mode: '0700'

- name: Deploy SSH public key for admin user
  authorized_key:
    user: "{{ admin_user.username }}"
    key: "{{ lookup('file', admin_user.ssh_public_key_path) }}"
    state: present
  when: admin_user.ssh_public_key_path is defined
