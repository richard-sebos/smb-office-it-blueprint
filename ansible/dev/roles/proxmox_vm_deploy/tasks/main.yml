---
################################################################################
# Role: proxmox_vm_deploy
# Purpose: Deploy VM on Proxmox using qm commands
################################################################################

- name: Debug - Check PATH on Proxmox host
  shell: echo $PATH
  register: path_debug
  changed_when: false

- name: Debug - Display PATH
  debug:
    msg: "PATH on Proxmox: {{ path_debug.stdout }}"

- name: Debug - Find qm executable
  shell: "which qm || find /usr -name qm 2>/dev/null || echo 'qm not found'"
  register: qm_location
  changed_when: false

- name: Debug - Display qm location
  debug:
    msg: "qm location: {{ qm_location.stdout }}"

- name: Debug - Check qm file details
  shell: "ls -la /usr/sbin/qm; file /usr/sbin/qm"
  register: qm_file_check
  changed_when: false
  failed_when: false

- name: Debug - Display qm file details
  debug:
    msg: "qm file details: {{ qm_file_check.stdout_lines }}"

- name: Debug - Test qm execution directly
  shell: "qm list"
  register: qm_direct_test
  changed_when: false
  failed_when: false

- name: Debug - Display qm direct test
  debug:
    msg: "qm direct test: {{ qm_direct_test }}"

- name: Set Proxmox command paths
  set_fact:
    qm_cmd: qm
    pvesh_cmd: pvesh

- name: Check if VM already exists
  shell: "{{ qm_cmd }} list | grep -w '{{ vmid }}' || true"
  register: vm_exists
  changed_when: false

- name: Clone VM from template
  shell: |
    {{ qm_cmd }} clone {{ template_id }} {{ vmid }} \
      --name {{ hostname }} \
      --storage {{ proxmox.storage }} \
      --full
  when: vm_exists.stdout == ""

- name: Configure VM resources
  shell: |
    {{ qm_cmd }} set {{ vmid }} \
      --cores {{ resources.cores }} \
      --memory {{ resources.memory }}

- name: Resize VM disk
  shell: |
    {{ qm_cmd }} resize {{ vmid }} scsi0 {{ resources.disk_size }}
  when: vm_exists.stdout == ""

- name: Configure VM network
  shell: |
    {{ qm_cmd }} set {{ vmid }} \
      --net0 virtio,bridge=vmbr1,tag={{ network.vlan }},firewall=0

- name: Configure cloud-init network settings
  shell: |
    {{ qm_cmd }} set {{ vmid }} \
      --ipconfig0 ip={{ network.ip_address }}/{{ network.netmask }},gw={{ network.gateway }} \
      --nameserver {{ network.dns_servers | join(',') }} \
      --searchdomain {{ network.search_domain }}

- name: Set VM description
  shell: |
    {{ qm_cmd }} set {{ vmid }} --description "{{ fqdn }}

    VM ID: {{ vmid }}
    IP: {{ network.ip_address }}/{{ network.netmask }}
    Gateway: {{ network.gateway }}
    VLAN: {{ network.vlan }}
    OS: {{ os_type | capitalize }} {{ os_version }}

    Managed by Ansible"

- name: Apply Proxmox tags
  shell: |
    {{ qm_cmd }} set {{ vmid }} --tags "{{ proxmox.tags | join(';') }}"

- name: Ensure resource pool exists
  shell: |
    {{ pvesh_cmd }} get /pools/{{ proxmox.pool }} 2>/dev/null || \
    {{ pvesh_cmd }} create /pools --poolid {{ proxmox.pool }} --comment "Auto-created by Ansible"
  register: pool_check
  changed_when: "'created' in pool_check.stdout"
  failed_when: false

- name: Add VM to resource pool
  shell: |
    {{ pvesh_cmd }} set /pools/{{ proxmox.pool }} --vms {{ vmid }}
  register: pool_result
  failed_when:
    - pool_result.rc != 0
    - "'already exists' not in pool_result.stderr"

- name: Start VM
  shell: |
    {{ qm_cmd }} start {{ vmid }}
  register: vm_start
  failed_when:
    - vm_start.rc != 0
    - "'already running' not in vm_start.stderr"

- name: Wait for VM to boot
  pause:
    seconds: 30
    prompt: "Waiting for VM {{ hostname }} to boot..."

- name: Wait for SSH to become available
  wait_for:
    host: "{{ network.ip_address }}"
    port: 22
    delay: 10
    timeout: 300
    state: started
  delegate_to: localhost

- name: Display deployment summary
  debug:
    msg:
      - "========================================="
      - "VM Deployed Successfully!"
      - "========================================="
      - "Hostname: {{ hostname }}"
      - "VMID: {{ vmid }}"
      - "IP: {{ network.ip_address }}"
      - "FQDN: {{ fqdn }}"
      - "========================================="
