---
################################################################################
# Role: proxmox_vm_deploy
# Purpose: Deploy VM on Proxmox using qm commands
################################################################################

- name: Check if VM already exists
  shell: qm list | grep -w "{{ hostvars[inventory_hostname].vmid }}" || true
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root
  register: vm_exists
  changed_when: false

- name: Clone VM from template
  shell: |
    qm clone {{ hostvars[inventory_hostname].template_id }} {{ hostvars[inventory_hostname].vmid }} \
      --name {{ hostvars[inventory_hostname].hostname }} \
      --storage {{ hostvars[inventory_hostname].proxmox.storage }} \
      --full
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root
  when: vm_exists.stdout == ""

- name: Configure VM resources
  shell: |
    qm set {{ hostvars[inventory_hostname].vmid }} \
      --cores {{ hostvars[inventory_hostname].resources.cores }} \
      --memory {{ hostvars[inventory_hostname].resources.memory }}
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root

- name: Resize VM disk
  shell: |
    qm resize {{ hostvars[inventory_hostname].vmid }} scsi0 {{ hostvars[inventory_hostname].resources.disk_size }}
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root
  when: vm_exists.stdout == ""

- name: Configure VM network
  shell: |
    qm set {{ hostvars[inventory_hostname].vmid }} \
      --net0 virtio,bridge=vmbr1,tag={{ hostvars[inventory_hostname].network.vlan }},firewall=0
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root

- name: Configure cloud-init network settings
  shell: |
    qm set {{ hostvars[inventory_hostname].vmid }} \
      --ipconfig0 ip={{ hostvars[inventory_hostname].network.ip_address }}/{{ hostvars[inventory_hostname].network.netmask }},gw={{ hostvars[inventory_hostname].network.gateway }} \
      --nameserver {{ hostvars[inventory_hostname].network.dns_servers | join(',') }} \
      --searchdomain {{ hostvars[inventory_hostname].network.search_domain }}
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root

- name: Set VM description
  shell: |
    qm set {{ hostvars[inventory_hostname].vmid }} --description "{{ hostvars[inventory_hostname].fqdn }}

    VM ID: {{ hostvars[inventory_hostname].vmid }}
    IP: {{ hostvars[inventory_hostname].network.ip_address }}/{{ hostvars[inventory_hostname].network.netmask }}
    Gateway: {{ hostvars[inventory_hostname].network.gateway }}
    VLAN: {{ hostvars[inventory_hostname].network.vlan }}
    OS: {{ hostvars[inventory_hostname].os_type | capitalize }} {{ hostvars[inventory_hostname].os_version }}

    Managed by Ansible"
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root

- name: Apply Proxmox tags
  shell: |
    qm set {{ hostvars[inventory_hostname].vmid }} --tags "{{ hostvars[inventory_hostname].proxmox.tags | join(';') }}"
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root

- name: Ensure resource pool exists
  shell: |
    pvesh get /pools/{{ hostvars[inventory_hostname].proxmox.pool }} 2>/dev/null || \
    pvesh create /pools --poolid {{ hostvars[inventory_hostname].proxmox.pool }} --comment "Auto-created by Ansible"
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root
  register: pool_check
  changed_when: "'created' in pool_check.stdout"
  failed_when: false

- name: Add VM to resource pool
  shell: |
    pvesh set /pools/{{ hostvars[inventory_hostname].proxmox.pool }} --vms {{ hostvars[inventory_hostname].vmid }}
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root
  register: pool_result
  failed_when:
    - pool_result.rc != 0
    - "'already exists' not in pool_result.stderr"

- name: Start VM
  shell: |
    qm start {{ hostvars[inventory_hostname].vmid }}
  delegate_to: "{{ proxmox_host }}"
  vars:
    ansible_user: root
  register: vm_start
  failed_when:
    - vm_start.rc != 0
    - "'already running' not in vm_start.stderr"

- name: Wait for VM to boot
  pause:
    seconds: 30
    prompt: "Waiting for VM {{ hostvars[inventory_hostname].hostname }} to boot..."

- name: Wait for SSH to become available
  wait_for:
    host: "{{ hostvars[inventory_hostname].network.ip_address }}"
    port: 22
    delay: 10
    timeout: 300
    state: started
  delegate_to: localhost

- name: Display deployment summary
  debug:
    msg:
      - "========================================="
      - "VM Deployed Successfully!"
      - "========================================="
      - "Hostname: {{ hostvars[inventory_hostname].hostname }}"
      - "VMID: {{ hostvars[inventory_hostname].vmid }}"
      - "IP: {{ hostvars[inventory_hostname].network.ip_address }}"
      - "FQDN: {{ hostvars[inventory_hostname].fqdn }}"
      - "========================================="
