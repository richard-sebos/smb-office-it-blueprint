---
################################################################################
# Role: proxmox_vm_deploy
# Purpose: Deploy VM on Proxmox using qm commands
################################################################################

- name: Set Proxmox command paths
  set_fact:
    qm_cmd: /usr/sbin/qm
    pvesh_cmd: /usr/sbin/pvesh

- name: Check if VM already exists
  shell: "{{ qm_cmd }} list | grep -w '{{ vmid }}' || true"
  delegate_to: pve
  register: vm_exists
  changed_when: false
  environment: "{{ proxmox_environment }}"

- name: Clone VM from template
  shell: |
    {{ qm_cmd }} clone {{ template_id }} {{ vmid }} \
      --name {{ hostname }} \
      --storage {{ proxmox.storage }} \
      --full
  delegate_to: pve
  when: vm_exists.stdout == ""
  environment: "{{ proxmox_environment }}"

- name: Configure VM resources
  shell: |
    {{ qm_cmd }} set {{ vmid }} \
      --cores {{ resources.cores }} \
      --memory {{ resources.memory }}
  delegate_to: pve
  environment: "{{ proxmox_environment }}"

- name: Resize VM disk
  shell: |
    {{ qm_cmd }} resize {{ vmid }} scsi0 {{ resources.disk_size }}
  delegate_to: pve
  when: vm_exists.stdout == ""
  environment: "{{ proxmox_environment }}"

- name: Configure VM network
  shell: |
    {{ qm_cmd }} set {{ vmid }} \
      --net0 virtio,bridge=vmbr1,tag={{ network.vlan }},firewall=0
  delegate_to: pve
  environment: "{{ proxmox_environment }}"

- name: Configure cloud-init network settings
  shell: |
    {{ qm_cmd }} set {{ vmid }} \
      --ipconfig0 ip={{ network.ip_address }}/{{ network.netmask }},gw={{ network.gateway }} \
      --nameserver {{ network.dns_servers | join(',') }} \
      --searchdomain {{ network.search_domain }}
  delegate_to: pve
  environment: "{{ proxmox_environment }}"

- name: Set VM description
  shell: |
    {{ qm_cmd }} set {{ vmid }} --description "{{ fqdn }}

    VM ID: {{ vmid }}
    IP: {{ network.ip_address }}/{{ network.netmask }}
    Gateway: {{ network.gateway }}
    VLAN: {{ network.vlan }}
    OS: {{ os_type | capitalize }} {{ os_version }}

    Managed by Ansible"
  delegate_to: pve
  environment: "{{ proxmox_environment }}"

- name: Apply Proxmox tags
  shell: |
    {{ qm_cmd }} set {{ vmid }} --tags "{{ proxmox.tags | join(';') }}"
  delegate_to: pve
  environment: "{{ proxmox_environment }}"

- name: Ensure resource pool exists
  shell: |
    {{ pvesh_cmd }} get /pools/{{ proxmox.pool }} 2>/dev/null || \
    {{ pvesh_cmd }} create /pools --poolid {{ proxmox.pool }} --comment "Auto-created by Ansible"
  delegate_to: pve
  register: pool_check
  changed_when: "'created' in pool_check.stdout"
  failed_when: false
  environment: "{{ proxmox_environment }}"

- name: Add VM to resource pool
  shell: |
    {{ pvesh_cmd }} set /pools/{{ proxmox.pool }} --vms {{ vmid }}
  delegate_to: pve
  register: pool_result
  failed_when:
    - pool_result.rc != 0
    - "'already exists' not in pool_result.stderr"
  environment: "{{ proxmox_environment }}"

- name: Start VM
  shell: |
    {{ qm_cmd }} start {{ vmid }}
  delegate_to: pve
  register: vm_start
  failed_when:
    - vm_start.rc != 0
    - "'already running' not in vm_start.stderr"
  environment: "{{ proxmox_environment }}"

- name: Wait for VM to boot
  pause:
    seconds: 30
    prompt: "Waiting for VM {{ hostname }} to boot..."

- name: Wait for SSH to become available
  wait_for:
    host: "{{ network.ip_address }}"
    port: 22
    delay: 10
    timeout: 300
    state: started
  delegate_to: localhost

- name: Display deployment summary
  debug:
    msg:
      - "========================================="
      - "VM Deployed Successfully!"
      - "========================================="
      - "Hostname: {{ hostname }}"
      - "VMID: {{ vmid }}"
      - "IP: {{ network.ip_address }}"
      - "FQDN: {{ fqdn }}"
      - "========================================="
