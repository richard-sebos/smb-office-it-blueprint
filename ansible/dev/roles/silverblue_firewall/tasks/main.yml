---
################################################################################
# Role: silverblue_firewall
# Tasks: Configure firewalld with whitelist rules
################################################################################

- name: Display firewall configuration
  debug:
    msg:
      - "Configuring firewall for {{ hostname }}"
      - "Zone: {{ firewall.default_zone | default(default_firewall_zone) }}"
      - "Services: {{ firewall.allowed_services | length if firewall.allowed_services is defined else 0 }}"
      - "Destinations: {{ firewall.allowed_destinations | length if firewall.allowed_destinations is defined else 0 }}"

- name: Check if firewalld is installed
  command: rpm -q firewalld
  register: firewalld_check
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Install firewalld via rpm-ostree
  command: rpm-ostree install firewalld
  register: firewalld_install
  changed_when: "'Installing' in firewalld_install.stdout"
  when: firewalld_check.rc != 0
  failed_when: false
  ignore_errors: yes

- name: Reboot if firewalld was installed
  reboot:
    msg: "Rebooting to apply firewalld installation"
    reboot_timeout: 300
  when:
    - firewalld_install is defined
    - firewalld_install.changed
  ignore_errors: yes

- name: Wait for system after reboot
  wait_for_connection:
    delay: 10
    timeout: 300
  when:
    - firewalld_install is defined
    - firewalld_install.changed
  ignore_errors: yes

- name: Enable and start firewalld
  systemd:
    name: firewalld
    enabled: yes
    state: started
  ignore_errors: yes

- name: Set default zone
  command: firewall-cmd --set-default-zone={{ firewall.default_zone | default(default_firewall_zone) }}
  changed_when: false
  ignore_errors: yes

- name: Allow SSH from management network
  firewalld:
    zone: "{{ firewall.default_zone | default(default_firewall_zone) }}"
    source: "{{ item.cidr }}"
    service: ssh
    permanent: yes
    state: enabled
  loop: "{{ ssh.allowed_networks }}"
  when: ssh.allowed_networks is defined
  notify: reload firewall
  ignore_errors: yes

- name: Allow required services
  firewalld:
    zone: "{{ firewall.default_zone | default(default_firewall_zone) }}"
    service: "{{ item }}"
    permanent: yes
    state: enabled
  loop: "{{ firewall.allowed_services }}"
  when: firewall.allowed_services is defined
  notify: reload firewall
  ignore_errors: yes

- name: Allow required ports
  firewalld:
    zone: "{{ firewall.default_zone | default(default_firewall_zone) }}"
    port: "{{ item }}"
    permanent: yes
    state: enabled
  loop: "{{ firewall.allowed_ports }}"
  when: firewall.allowed_ports is defined
  notify: reload firewall
  ignore_errors: yes

- name: Create rich rules for specific destinations
  firewalld:
    zone: "{{ firewall.default_zone | default(default_firewall_zone) }}"
    rich_rule: "rule family=ipv4 destination address={{ item }} accept"
    permanent: yes
    state: enabled
  loop: "{{ firewall.allowed_destinations }}"
  when: firewall.allowed_destinations is defined
  notify: reload firewall
  ignore_errors: yes

- name: Display firewall configuration summary
  debug:
    msg:
      - "Firewall configured:"
      - "  • Default zone: {{ firewall.default_zone | default(default_firewall_zone) }}"
      - "  • Allowed services: {{ firewall.allowed_services | join(', ') if firewall.allowed_services is defined else 'none' }}"
      - "  • Allowed ports: {{ firewall.allowed_ports | join(', ') if firewall.allowed_ports is defined else 'none' }}"
      - "  • Whitelisted destinations: {{ firewall.allowed_destinations | length if firewall.allowed_destinations is defined else 0 }}"
