#!/bin/bash
################################################################################
# Samba AD Administrative Tools
# Generated by Ansible for {{ ad_domain }}
################################################################################

DOMAIN="{{ ad_domain }}"
REALM="{{ ad_realm }}"
DC_IP="{{ ad_dc_ip }}"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${GREEN}=================================${NC}"
echo -e "${GREEN}Samba AD Administrative Tools${NC}"
echo -e "${GREEN}Domain: ${DOMAIN}${NC}"
echo -e "${GREEN}=================================${NC}"
echo ""

PS3="Select an option: "
options=(
    "List all users"
    "Create new user"
    "Set user password"
    "List all groups"
    "Create new group"
    "Add user to group"
    "Show domain level"
    "Test DNS resolution"
    "Test Kerberos authentication"
    "Show service status"
    "View logs"
    "Exit"
)

select opt in "${options[@]}"
do
    case $opt in
        "List all users")
            echo -e "${YELLOW}Listing all domain users...${NC}"
            samba-tool user list
            echo ""
            ;;
        "Create new user")
            read -p "Enter username: " username
            read -p "Enter first name: " firstname
            read -p "Enter last name: " lastname
            echo -e "${YELLOW}Creating user ${username}...${NC}"
            samba-tool user add "$username" --given-name="$firstname" --surname="$lastname"
            echo ""
            ;;
        "Set user password")
            read -p "Enter username: " username
            echo -e "${YELLOW}Setting password for ${username}...${NC}"
            samba-tool user setpassword "$username"
            echo ""
            ;;
        "List all groups")
            echo -e "${YELLOW}Listing all security groups...${NC}"
            samba-tool group list
            echo ""
            ;;
        "Create new group")
            read -p "Enter group name: " groupname
            echo -e "${YELLOW}Creating group ${groupname}...${NC}"
            samba-tool group add "$groupname"
            echo ""
            ;;
        "Add user to group")
            read -p "Enter group name: " groupname
            read -p "Enter username to add: " username
            echo -e "${YELLOW}Adding ${username} to ${groupname}...${NC}"
            samba-tool group addmembers "$groupname" "$username"
            echo ""
            ;;
        "Show domain level")
            echo -e "${YELLOW}Domain functional level:${NC}"
            samba-tool domain level show
            echo ""
            ;;
        "Test DNS resolution")
            echo -e "${YELLOW}Testing DNS resolution...${NC}"
            host -t A "$DOMAIN" 127.0.0.1
            host -t SRV "_ldap._tcp.$DOMAIN" 127.0.0.1
            echo ""
            ;;
        "Test Kerberos authentication")
            echo -e "${YELLOW}Testing Kerberos authentication...${NC}"
            echo "Enter administrator password:"
            kinit administrator@"$REALM"
            if [ $? -eq 0 ]; then
                echo -e "${GREEN}✓ Kerberos authentication successful${NC}"
                klist
                kdestroy
            else
                echo -e "${RED}✗ Kerberos authentication failed${NC}"
            fi
            echo ""
            ;;
        "Show service status")
            echo -e "${YELLOW}Samba AD DC service status:${NC}"
            systemctl status samba-ad-dc
            echo ""
            ;;
        "View logs")
            echo -e "${YELLOW}Showing recent logs (Ctrl+C to exit)...${NC}"
            journalctl -u samba-ad-dc -n 100 -f
            ;;
        "Exit")
            echo "Goodbye!"
            break
            ;;
        *) echo "Invalid option $REPLY";;
    esac
done
