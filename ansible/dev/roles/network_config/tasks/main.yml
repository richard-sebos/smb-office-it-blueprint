---
################################################################################
# Role: network_config
# Purpose: Configure static network settings for Ubuntu or Rocky Linux
################################################################################
- name: Configure static IP with netplan (Ubuntu)
  when: os_type == "ubuntu"
  block:
    - name: Create netplan configuration
      template:
        src: netplan-static.j2
        dest: /etc/netplan/01-netcfg.yaml
        owner: root
        group: root
        mode: '0600'

    - name: Apply netplan configuration
      command: netplan apply
      register: netplan_result
      changed_when: netplan_result.rc == 0

- name: Configure static IP with NetworkManager (Rocky)
  when: os_type == "rocky"
  block:
    - name: Check if NetworkManager connection file exists
      stat:
        path: /etc/NetworkManager/system-connections/{{ network.interface }}.nmconnection
      register: nm_file

    - name: Backup existing NetworkManager connection
      copy:
        src: /etc/NetworkManager/system-connections/{{ network.interface }}.nmconnection
        dest: /etc/NetworkManager/system-connections/{{ network.interface }}.nmconnection.backup
        remote_src: yes
      when: nm_file.stat.exists

    - name: Create NetworkManager connection from template
      template:
        src: nmconnection-static.j2
        dest: /etc/NetworkManager/system-connections/{{ network.interface }}.nmconnection
        owner: root
        group: root
        mode: '0600'

    - name: Reload NetworkManager
      systemd:
        name: NetworkManager
        state: reloaded

    - name: Bring up connection
      command: nmcli connection up {{ network.interface }}
      register: nmcli_result
      changed_when: "'successfully activated' in nmcli_result.stdout"
      failed_when: false
