#!/bin/bash
################################################################################
# Workstation Nightly Reset Script
# Generated by Ansible for {{ hostname }}
#
# Purpose: Reset immutable workstation to clean state nightly
# Security: Prevents malware persistence, clears local data
################################################################################

set -euo pipefail

LOG_FILE="/var/log/workstation-reset/reset-$(date +%Y%m%d).log"
MONITORING_SERVER="{{ logging.rsyslog.target }}"
WORKSTATION_NAME="{{ hostname }}"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
    logger -t workstation-reset "$*"
}

log "========================================="
log "Starting nightly reset for $WORKSTATION_NAME"
log "========================================="

# Step 1: Sync logs to monitoring server (preserve audit trail)
log "Step 1: Syncing logs to monitoring server..."
if rsync -avz --timeout=60 /var/log/* "$MONITORING_SERVER:{{ monitoring.monitoring_level | default('var') }}/log/workstations/$WORKSTATION_NAME/$(date +%Y%m%d)/" 2>&1 | tee -a "$LOG_FILE"; then
    log "Logs synced successfully to monitoring server"
else
    log "WARNING: Failed to sync logs to monitoring server (continuing anyway)"
fi

# Step 2: Clear ephemeral user data
log "Step 2: Clearing ephemeral user data..."

# Clear home directories (except .ssh for ansible-admin)
for homedir in /home/*; do
    if [ -d "$homedir" ] && [ "$(basename "$homedir")" != "ansible-admin" ]; then
        log "Clearing $homedir"
        rm -rf "$homedir"/* 2>&1 | tee -a "$LOG_FILE" || true
        rm -rf "$homedir"/.* 2>&1 | tee -a "$LOG_FILE" || true
    fi
done

# Clear temporary directories
log "Clearing /tmp and /var/tmp..."
rm -rf /tmp/* 2>&1 | tee -a "$LOG_FILE" || true
rm -rf /var/tmp/* 2>&1 | tee -a "$LOG_FILE" || true

# Clear browser caches (Firefox, Chrome)
log "Clearing browser caches..."
rm -rf /home/*/.mozilla/firefox/*/cache* 2>&1 | tee -a "$LOG_FILE" || true
rm -rf /home/*/.cache/mozilla 2>&1 | tee -a "$LOG_FILE" || true
rm -rf /home/*/.cache/google-chrome 2>&1 | tee -a "$LOG_FILE" || true

log "Ephemeral data cleared"

# Step 3: Reset OSTree to base snapshot
log "Step 3: Resetting OSTree to base snapshot..."
if rpm-ostree reset 2>&1 | tee -a "$LOG_FILE"; then
    log "OSTree reset successful"
else
    log "ERROR: OSTree reset failed! System may be in inconsistent state"
    # Alert monitoring system
    logger -p user.crit -t workstation-reset "CRITICAL: OSTree reset failed on $WORKSTATION_NAME"
fi

# Step 4: Verify system integrity
log "Step 4: Verifying system integrity..."
CURRENT_DEPLOYMENT=$(rpm-ostree status --json | jq -r '.deployments[0].checksum')
log "Current OSTree deployment: $CURRENT_DEPLOYMENT"

# Step 5: Schedule reboot
log "Step 5: Scheduling reboot..."
log "Nightly reset complete - rebooting in 60 seconds"

# Final log sync before reboot
rsync -avz --timeout=30 /var/log/workstation-reset/* "$MONITORING_SERVER:{{ monitoring.monitoring_level | default('var') }}/log/workstations/$WORKSTATION_NAME/reset-logs/" 2>&1 | tee -a "$LOG_FILE" || true

log "========================================="
log "Nightly reset complete - initiating reboot"
log "========================================="

# Reboot the system
sleep 5
systemctl reboot
