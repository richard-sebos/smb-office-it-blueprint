---
################################################################################
# Role: silverblue_ad_integration
# Tasks: Configure AD authentication via SSSD + Kerberos
################################################################################

- name: Check if we're on Fedora Silverblue
  fail:
    msg: "This role is designed for Fedora Silverblue (OSTree-based systems)"
  when: ansible_distribution != "Fedora" or ansible_pkg_mgr != "atomic_container"

- name: Check currently layered packages
  command: rpm-ostree status --json
  register: ostree_status_json
  changed_when: false
  failed_when: false

- name: Parse layered packages
  set_fact:
    layered_packages: "{{ (ostree_status_json.stdout | from_json).deployments[0].packages | default([]) }}"
  when: ostree_status_json.rc == 0

- name: Determine packages that need to be installed
  set_fact:
    packages_to_install: "{{ ad_required_packages | difference(layered_packages | default([])) }}"

- name: Display packages to be installed
  debug:
    msg: "Packages to install: {{ packages_to_install | join(', ') if packages_to_install | length > 0 else 'none (all already installed)' }}"

- name: Layer required AD packages onto OSTree
  command: rpm-ostree install {{ packages_to_install | join(' ') }}
  register: ostree_layer
  changed_when: "'Installing' in ostree_layer.stdout"
  when: packages_to_install | length > 0
  notify: reboot workstation

- name: Reboot if packages were layered
  reboot:
    msg: "Rebooting to apply rpm-ostree package layering"
    reboot_timeout: 300
  when:
    - ostree_layer is defined
    - ostree_layer.changed
  ignore_errors: yes

- name: Wait for system to come back online
  wait_for_connection:
    delay: 10
    timeout: 300
  when:
    - ostree_layer is defined
    - ostree_layer.changed
  ignore_errors: yes

- name: Create Kerberos configuration
  template:
    src: krb5.conf.j2
    dest: /etc/krb5.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart sssd

- name: Create SSSD configuration
  template:
    src: sssd.conf.j2
    dest: /etc/sssd/sssd.conf
    owner: root
    group: root
    mode: '0600'
  notify: restart sssd

- name: Create SSSD config directory
  file:
    path: /etc/sssd/conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Enable automatic home directory creation (Fedora Silverblue)
  command: authselect enable-feature with-mkhomedir
  ignore_errors: yes

- name: Enable and start SSSD service
  systemd:
    name: sssd
    enabled: yes
    state: started

- name: Enable and start oddjobd service (for mkhomedir)
  systemd:
    name: oddjobd
    enabled: yes
    state: started

- name: Test AD connectivity
  command: "realm discover {{ ad_integration.domain }}"
  register: realm_discover
  changed_when: false
  failed_when: false

- name: Display AD discovery result
  debug:
    msg: "{{ realm_discover.stdout }}"
  when: realm_discover.rc == 0

- name: Join Active Directory domain
  command: >
    realm join --computer-ou="OU=Workstations,OU=Computers,DC=corp,DC=company,DC=local"
    --user={{ ad_join_user }}
    --verbose
    {{ ad_integration.domain }}
  environment:
    AD_PASSWORD: "{{ ad_join_password }}"
  when:
    - ad_join_user is defined
    - ad_join_password is defined
    - "'configured: no' in realm_discover.stdout or realm_discover.rc != 0"
  register: realm_join
  no_log: true

- name: Configure PAM to use SSSD for authentication
  command: authselect select sssd with-mkhomedir --force
  ignore_errors: yes

- name: Verify SSSD is working
  command: "id {{ test_ad_user }}@{{ ad_integration.domain }}"
  register: sssd_test
  when: test_ad_user is defined
  changed_when: false
  failed_when: false

- name: Display SSSD test result
  debug:
    msg: "SSSD is working: {{ sssd_test.stdout }}"
  when:
    - test_ad_user is defined
    - sssd_test.rc == 0
