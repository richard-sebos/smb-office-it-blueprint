---
################################################################################
# Playbook: Deploy and Configure ws-reception01
# Purpose: Deploy Fedora Silverblue receptionist workstation with AD integration
# Security Level: HIGH (Public Area Workstation)
################################################################################

- name: Deploy VM on Proxmox
  hosts: pve
  gather_facts: no

  vars:
    target_host: ws-reception01

  tasks:
    - name: Load host variables for target VM
      include_vars:
        file: ../host_vars/{{ target_host }}.yml

    - name: Include proxmox_vm_deploy role
      include_role:
        name: proxmox_vm_deploy

    - name: Display VM deployment status
      debug:
        msg:
          - "========================================="
          - "VM {{ hostname }} deployed successfully"
          - "VMID: {{ vmid }}"
          - "IP: {{ network.ip_address }}"
          - "VLAN: {{ network.vlan }}"
          - "========================================="

- name: Wait for VM to boot
  hosts: pve
  gather_facts: no

  tasks:
    - name: Wait 60 seconds for VM to fully boot
      pause:
        seconds: 60

- name: Configure ws-reception01 - Base System
  hosts: ws-reception01
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

    - name: Use management connection for initial configuration
      set_fact:
        ansible_host: "{{ network.mgmt_ip }}"
        ansible_user: "{{ network.mgmt_user }}"
      when:
        - network.mgmt_ip is defined
        - network.mgmt_user is defined

    - name: Display connection information
      debug:
        msg:
          - "Connecting to {{ hostname }}"
          - "Management IP: {{ network.mgmt_ip }}"
          - "Production IP: {{ network.ip_address }}"

    - name: Test connectivity
      ping:

  roles:
    - network_config
    - hostname_config
    - system_update

  post_tasks:
    - name: Display base configuration status
      debug:
        msg:
          - "========================================="
          - "Base system configuration complete"
          - "Hostname: {{ hostname }}"
          - "Network configured: {{ network.ip_address }}/{{ network.netmask }}"
          - "========================================="

- name: Configure ws-reception01 - Silverblue Security Features
  hosts: ws-reception01
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

  roles:
    - silverblue_ad_integration
    - silverblue_pam_access
    - silverblue_printer_config
    - silverblue_nightly_reset

  post_tasks:
    - name: Configure rsyslog for remote logging
      template:
        src: ../roles/silverblue_ad_integration/templates/rsyslog-remote.conf.j2
        dest: /etc/rsyslog.d/50-remote.conf
        owner: root
        group: root
        mode: '0644'
      notify: restart rsyslog

    - name: Enable and start rsyslog
      systemd:
        name: rsyslog
        enabled: yes
        state: started

    - name: Configure auditd rules
      copy:
        dest: /etc/audit/rules.d/workstation.rules
        content: |
          # Workstation audit rules for {{ hostname }}
          # Generated by Ansible

          # Log all authentication events
          -w /var/log/auth.log -p wa -k auth_log
          -w /var/log/secure -p wa -k secure_log

          # Log user login/logout
          -w /var/log/lastlog -p wa -k login_logout
          -w /var/run/faillock/ -p wa -k login_failures

          # Log sudo usage
          -w /etc/sudoers -p wa -k sudoers_changes
          -w /etc/sudoers.d/ -p wa -k sudoers_changes

          # Log PAM configuration changes
          -w /etc/pam.d/ -p wa -k pam_config
          -w /etc/security/access.conf -p wa -k access_control

          # Log SSSD configuration
          -w /etc/sssd/sssd.conf -p wa -k sssd_config

          # Make configuration immutable
          -e 2
        owner: root
        group: root
        mode: '0640'
      notify: restart auditd

    - name: Display security configuration status
      debug:
        msg:
          - "========================================="
          - "Security features configured:"
          - "  ✓ AD Integration (SSSD + Kerberos)"
          - "  ✓ PAM Access Control (Receptionists group only)"
          - "  ✓ Printer Configuration ({{ printers | length }} printers)"
          - "  ✓ Nightly Reset ({{ nightly_reset.reset_time }})"
          - "  ✓ Remote Logging ({{ logging.rsyslog.target }})"
          - "  ✓ Auditd Rules"
          - "========================================="

  handlers:
    - name: restart rsyslog
      systemd:
        name: rsyslog
        state: restarted

    - name: restart auditd
      systemd:
        name: auditd
        state: restarted

- name: Configure ws-reception01 - Desktop Environment
  hosts: ws-reception01
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

  tasks:
    - name: Configure GNOME idle timeout (3 minutes for public area)
      command: |
        gsettings set org.gnome.desktop.session idle-delay {{ session_security.idle_timeout_minutes * 60 }}
      become: no
      become_user: "{{ item }}"
      loop:
        - gdm
      when: session_security.idle_timeout_minutes is defined

    - name: Configure GNOME screen lock
      command: |
        gsettings set org.gnome.desktop.screensaver lock-enabled true
      become: no
      become_user: gdm
      when: session_security.screen_lock_enabled | default(true)

    - name: Configure GNOME to lock on suspend
      command: |
        gsettings set org.gnome.desktop.screensaver lock-delay 0
      become: no
      become_user: gdm
      when: session_security.lock_on_suspend | default(true)

    - name: Create browser bookmarks file
      template:
        dest: /etc/firefox/policies/policies.json
        content: |
          {
            "policies": {
              "DisplayBookmarksToolbar": true,
              "Bookmarks": [
          {% for bookmark in desktop_environment.browser_bookmarks %}
                {
                  "Title": "{{ bookmark.name }}",
                  "URL": "{{ bookmark.url }}"
                }{{ "," if not loop.last else "" }}
          {% endfor %}
              ],
              "Homepage": {
                "URL": "{{ desktop_environment.browser_bookmarks[0].url }}",
                "Locked": false
              }
            }
          }
        owner: root
        group: root
        mode: '0644'
      when: desktop_environment.browser_bookmarks is defined

    - name: Display desktop configuration status
      debug:
        msg:
          - "========================================="
          - "Desktop environment configured:"
          - "  ✓ GNOME idle timeout: {{ session_security.idle_timeout_minutes }} minutes"
          - "  ✓ Screen lock enabled"
          - "  ✓ Browser bookmarks configured"
          - "========================================="

- name: Configure ws-reception01 - Firewall Rules
  hosts: ws-reception01
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

  tasks:
    - name: Install firewalld
      command: rpm-ostree install firewalld
      register: firewalld_install
      changed_when: "'Installing' in firewalld_install.stdout"
      failed_when: false

    - name: Reboot if firewalld was installed
      reboot:
        msg: "Rebooting to apply firewalld installation"
        reboot_timeout: 300
      when: firewalld_install.changed

    - name: Enable and start firewalld
      systemd:
        name: firewalld
        enabled: yes
        state: started

    - name: Set default zone to workstation
      command: firewall-cmd --set-default-zone=workstation
      changed_when: false

    - name: Allow SSH from management network
      firewalld:
        zone: workstation
        source: "{{ item.cidr }}"
        service: ssh
        permanent: yes
        state: enabled
      loop: "{{ ssh.allowed_networks }}"
      when: ssh.allowed_networks is defined
      notify: reload firewall

    - name: Allow required services
      firewalld:
        zone: workstation
        service: "{{ item }}"
        permanent: yes
        state: enabled
      loop: "{{ firewall.allowed_services }}"
      when: firewall.allowed_services is defined
      notify: reload firewall

    - name: Allow required ports
      firewalld:
        zone: workstation
        port: "{{ item }}"
        permanent: yes
        state: enabled
      loop: "{{ firewall.allowed_ports }}"
      when: firewall.allowed_ports is defined
      notify: reload firewall

    - name: Create rich rules for specific destinations
      firewalld:
        zone: workstation
        rich_rule: "rule family=ipv4 destination address={{ item }} accept"
        permanent: yes
        state: enabled
      loop: "{{ firewall.allowed_destinations }}"
      when: firewall.allowed_destinations is defined
      notify: reload firewall

    - name: Display firewall configuration
      debug:
        msg:
          - "========================================="
          - "Firewall configured:"
          - "  Default zone: workstation"
          - "  Allowed services: {{ firewall.allowed_services | join(', ') }}"
          - "  Whitelisted destinations: {{ firewall.allowed_destinations | length }} servers"
          - "========================================="

  handlers:
    - name: reload firewall
      command: firewall-cmd --reload

- name: Finalize ws-reception01 Configuration
  hosts: ws-reception01
  become: yes
  gather_facts: yes

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

  tasks:
    - name: Remove temporary management interface
      block:
        - name: Delete management interface connection
          file:
            path: "/etc/NetworkManager/system-connections/{{ network.mgmt_interface }}.nmconnection"
            state: absent
          when: network.mgmt_remove_after_config | default(false)

        - name: Reload NetworkManager
          systemd:
            name: NetworkManager
            state: reloaded
          when: network.mgmt_remove_after_config | default(false)

    - name: Create deployment verification script
      copy:
        dest: /usr/local/bin/verify-workstation.sh
        content: |
          #!/bin/bash
          echo "========================================="
          echo "Workstation Verification Script"
          echo "Hostname: {{ hostname }}"
          echo "========================================="
          echo ""
          echo "Network Configuration:"
          ip addr show {{ network.interface }} | grep inet
          echo ""
          echo "AD Integration:"
          realm list
          echo ""
          echo "SSSD Status:"
          systemctl status sssd --no-pager
          echo ""
          echo "Printer Status:"
          lpstat -p -d
          echo ""
          echo "Nightly Reset Timer:"
          systemctl status workstation-nightly-reset.timer --no-pager
          echo ""
          echo "OSTree Status:"
          rpm-ostree status
          echo ""
          echo "========================================="
        mode: '0755'
        owner: root
        group: root

    - name: Display final deployment summary
      debug:
        msg:
          - "========================================="
          - "WORKSTATION DEPLOYMENT COMPLETE"
          - "========================================="
          - ""
          - "Hostname: {{ hostname }}"
          - "FQDN: {{ fqdn }}"
          - "IP Address: {{ network.ip_address }}/{{ network.netmask }}"
          - "VLAN: {{ network.vlan }}"
          - "Gateway: {{ network.gateway }}"
          - ""
          - "OS: Fedora Silverblue {{ os_version }} (Immutable)"
          - "Workstation Type: {{ workstation_type | upper }}"
          - "Security Level: {{ security_level | upper }}"
          - ""
          - "Security Features:"
          - "  ✓ AD Integration: {{ ad_integration.domain }}"
          - "  ✓ Allowed Groups: {{ access_control.allowed_ad_groups | join(', ') }}"
          - "  ✓ Idle Timeout: {{ session_security.idle_timeout_minutes }} minutes"
          - "  ✓ Nightly Reset: {{ nightly_reset.reset_time }}"
          - "  ✓ Remote Logging: {{ logging.rsyslog.target }}"
          - "  ✓ Printers: {{ printers | length }} configured"
          - ""
          - "========================================="
          - "NEXT STEPS"
          - "========================================="
          - ""
          - "1. Verify deployment:"
          - "   ssh ansible-admin@{{ network.ip_address }}"
          - "   sudo /usr/local/bin/verify-workstation.sh"
          - ""
          - "2. Test AD login:"
          - "   Login as: sarah@{{ ad_integration.domain }}"
          - "   (Receptionists group members only)"
          - ""
          - "3. Monitor logs:"
          - "   On monitoring01: tail -f /var/log/workstations/{{ hostname }}/auth.log"
          - ""
          - "4. Test nightly reset:"
          - "   sudo systemctl start workstation-nightly-reset.service"
          - ""
          - "========================================="
