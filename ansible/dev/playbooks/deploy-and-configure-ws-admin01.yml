---
################################################################################
# Playbook: Deploy and Configure ws-admin01
# Purpose: Complete VM deployment and configuration
################################################################################

- name: Deploy VM on Proxmox
  hosts: pve
  gather_facts: no

  vars:
    target_host: ws-admin01

  tasks:
    - name: Load host variables for target VM
      include_vars:
        file: ../host_vars/{{ target_host }}.yml

    - name: Include proxmox_vm_deploy role
      include_role:
        name: proxmox_vm_deploy

- name: Configure ws-admin01
  hosts: ws-admin01
  become: yes
  gather_facts: no

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-admin01.yml

    - name: Override ansible_host with template IP for initial connection
      set_fact:
        ansible_host: "{{ network.template_ip }}"
      when: network.template_ip is defined

  roles:
    - network_config
    - hostname_config
    - system_update
    - install_packages
    - user_config
    - ssh_config
    - ssh_hardening
    - service_config

  post_tasks:
    - name: Display configuration summary
      debug:
        msg:
          - "========================================="
          - "VM Configuration Complete!"
          - "========================================="
          - "Hostname: {{ hostname }}"
          - "IP: {{ network.ip_address }}/{{ network.netmask }}"
          - "VLAN: {{ network.vlan }}"
          - "Gateway: {{ network.gateway }}"
          - "DNS: {{ network.dns_servers }}"
          - "========================================="
          - "Next steps:"
          - "  ssh {{ admin_user.username }}@{{ network.ip_address }}"
          - "========================================="
