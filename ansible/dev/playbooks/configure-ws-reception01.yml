---
################################################################################
# Playbook: Configure ws-reception01 Workstation
# Purpose: Configure Fedora Silverblue with AD integration and security features
# Prerequisites: VM must already be deployed and booted
# Usage: ansible-playbook playbooks/configure-ws-reception01.yml
################################################################################

- name: Configure ws-reception01 - Base System
  hosts: ws-reception01
  become: yes
  gather_facts: yes
  any_errors_fatal: false

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

    - name: Use management connection for initial configuration
      set_fact:
        ansible_host: "{{ network.mgmt_ip }}"
        ansible_user: "{{ network.mgmt_user }}"
      when:
        - network.mgmt_ip is defined
        - network.mgmt_user is defined

    - name: Display connection information
      debug:
        msg:
          - "========================================="
          - "CONFIGURING: {{ hostname }}"
          - "========================================="
          - "Management IP: {{ network.mgmt_ip }}"
          - "Production IP: {{ network.ip_address }}"
          - "========================================="

    - name: Test connectivity
      ping:

  roles:
    - role: network_config
      ignore_errors: yes
    - role: hostname_config
      ignore_errors: yes
    - role: system_update
      ignore_errors: yes

  post_tasks:
    - name: Display base configuration status
      debug:
        msg:
          - "========================================="
          - "✓ Base system configuration complete"
          - "  Hostname: {{ hostname }}"
          - "  Network: {{ network.ip_address }}/{{ network.netmask }}"
          - "========================================="

- name: Configure ws-reception01 - Security Features
  hosts: ws-reception01
  become: yes
  gather_facts: yes
  any_errors_fatal: false

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

  roles:
    - role: silverblue_ad_integration
      ignore_errors: yes
    - role: silverblue_pam_access
      ignore_errors: yes
    - role: silverblue_logging
      ignore_errors: yes
    - role: silverblue_printer_config
      ignore_errors: yes
    - role: silverblue_nightly_reset
      ignore_errors: yes

  post_tasks:
    - name: Display security configuration status
      debug:
        msg:
          - "========================================="
          - "✓ Security features configured:"
          - "  • AD Integration (SSSD + Kerberos)"
          - "  • PAM Access Control (Receptionists only)"
          - "  • Remote Logging (rsyslog + auditd)"
          - "  • Printer Configuration ({{ printers | length }} printers)"
          - "  • Nightly Reset ({{ nightly_reset.reset_time }})"
          - "========================================="

- name: Configure ws-reception01 - Desktop and Firewall
  hosts: ws-reception01
  become: yes
  gather_facts: yes
  any_errors_fatal: false

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

  roles:
    - role: silverblue_desktop_environment
      ignore_errors: yes
    - role: silverblue_firewall
      ignore_errors: yes

  post_tasks:
    - name: Display desktop and firewall status
      debug:
        msg:
          - "========================================="
          - "✓ Desktop environment configured"
          - "✓ Firewall configured"
          - "========================================="

- name: Configure ws-reception01 - Finalization
  hosts: ws-reception01
  become: yes
  gather_facts: yes
  any_errors_fatal: false

  pre_tasks:
    - name: Load host variables
      include_vars:
        file: ../host_vars/ws-reception01.yml

  roles:
    - role: silverblue_finalize
      ignore_errors: yes

  post_tasks:
    - name: Display final deployment summary
      debug:
        msg:
          - "========================================="
          - "WORKSTATION CONFIGURATION COMPLETE"
          - "========================================="
          - ""
          - "Hostname: {{ hostname }}"
          - "FQDN: {{ fqdn }}"
          - "IP Address: {{ network.ip_address }}/{{ network.netmask }}"
          - "VLAN: {{ network.vlan }}"
          - "Gateway: {{ network.gateway }}"
          - ""
          - "OS: Fedora Silverblue {{ os_version }} (Immutable)"
          - "Workstation Type: {{ workstation_type | upper }}"
          - "Security Level: {{ security_level | upper }}"
          - ""
          - "Security Features:"
          - "  ✓ AD Integration: {{ ad_integration.domain }}"
          - "  ✓ Allowed Groups: {{ access_control.allowed_ad_groups | join(', ') }}"
          - "  ✓ Idle Timeout: {{ session_security.idle_timeout_minutes }} minutes"
          - "  ✓ Nightly Reset: {{ nightly_reset.reset_time }}"
          - "  ✓ Remote Logging: {{ logging.rsyslog.target }}"
          - "  ✓ Printers: {{ printers | length }} configured"
          - ""
          - "========================================="
          - "NEXT STEPS"
          - "========================================="
          - ""
          - "1. Verify deployment:"
          - "   ssh ansible-admin@{{ network.ip_address }}"
          - "   sudo /usr/local/bin/verify-workstation.sh"
          - ""
          - "2. Test AD login:"
          - "   Login as: sarah@{{ ad_integration.domain }}"
          - "   (Receptionists group members only)"
          - ""
          - "3. Monitor logs:"
          - "   On monitoring01: tail -f /var/log/workstations/{{ hostname }}/auth.log"
          - ""
          - "4. Test nightly reset:"
          - "   sudo systemctl start workstation-nightly-reset.service"
          - ""
          - "========================================="
