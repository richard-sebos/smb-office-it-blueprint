---
################################################################################
# Playbook: Configure ws-admin01 (Admin Workstation)
# Purpose: Complete configuration of the admin workstation
################################################################################

- name: Configure Admin Workstation
  hosts: ws-admin01
  become: yes
  gather_facts: yes

  tasks:
    # ========================================================================
    # Network Configuration
    # ========================================================================

    - name: Configure static IP with netplan (Ubuntu)
      when: os_type == "ubuntu"
      block:
        - name: Create netplan configuration
          template:
            src: ../templates/netplan-static.j2
            dest: /etc/netplan/01-netcfg.yaml
            owner: root
            group: root
            mode: '0600'

        - name: Apply netplan configuration
          command: netplan apply
          register: netplan_result
          changed_when: netplan_result.rc == 0

    - name: Configure static IP with NetworkManager (Rocky)
      when: os_type == "rocky"
      block:
        - name: Create NetworkManager connection file
          template:
            src: ../templates/nmconnection-static.j2
            dest: /etc/NetworkManager/system-connections/ens18.nmconnection
            owner: root
            group: root
            mode: '0600'

        - name: Reload NetworkManager
          systemd:
            name: NetworkManager
            state: reloaded

        - name: Bring up connection
          command: nmcli connection up ens18
          register: nmcli_result
          changed_when: "'successfully activated' in nmcli_result.stdout"

    # ========================================================================
    # Hostname Configuration
    # ========================================================================

    - name: Set hostname
      hostname:
        name: "{{ hostname }}"

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ fqdn }} {{ hostname }}"
        owner: root
        group: root
        mode: '0644'

    # ========================================================================
    # System Updates
    # ========================================================================

    - name: Update apt cache (Ubuntu)
      when: os_type == "ubuntu"
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Upgrade all packages (Ubuntu)
      when: os_type == "ubuntu"
      apt:
        upgrade: dist
        autoremove: yes
        autoclean: yes

    - name: Update dnf cache (Rocky)
      when: os_type == "rocky"
      dnf:
        update_cache: yes

    - name: Upgrade all packages (Rocky)
      when: os_type == "rocky"
      dnf:
        name: "*"
        state: latest

    # ========================================================================
    # Install Base Packages
    # ========================================================================

    - name: Install base packages (Ubuntu)
      when: os_type == "ubuntu"
      apt:
        name: "{{ packages.base }}"
        state: present

    - name: Install admin tools (Ubuntu)
      when: os_type == "ubuntu"
      apt:
        name: "{{ packages.admin_tools }}"
        state: present

    - name: Install desktop applications (Ubuntu)
      when: os_type == "ubuntu"
      apt:
        name: "{{ packages.desktop }}"
        state: present
        allow_unauthenticated: yes  # For VS Code
      ignore_errors: yes  # VS Code might not be in default repos

    - name: Install base packages (Rocky)
      when: os_type == "rocky"
      dnf:
        name: "{{ packages.base }}"
        state: present

    - name: Install admin tools (Rocky)
      when: os_type == "rocky"
      dnf:
        name: "{{ packages.admin_tools }}"
        state: present

    # ========================================================================
    # User Configuration
    # ========================================================================

    - name: Ensure admin user exists
      user:
        name: "{{ admin_user.username }}"
        groups: "{{ admin_user.groups }}"
        shell: "{{ admin_user.shell }}"
        append: yes

    - name: Configure sudo access
      lineinfile:
        path: /etc/sudoers.d/{{ admin_user.username }}
        line: "{{ admin_user.username }} ALL=(ALL) NOPASSWD:ALL"
        create: yes
        validate: 'visudo -cf %s'
        mode: '0440'

    # ========================================================================
    # SSH Configuration
    # ========================================================================

    - name: Ensure SSH is enabled and started
      systemd:
        name: sshd
        enabled: yes
        state: started

    - name: Configure SSH to allow password authentication (temporary)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication yes'
        backup: yes
      notify: Restart SSH

    # ========================================================================
    # Service Management
    # ========================================================================

    - name: Enable required services
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop: "{{ services.enabled }}"
      when: services.enabled is defined

    - name: Disable unnecessary services
      systemd:
        name: "{{ item }}"
        enabled: no
        state: stopped
      loop: "{{ services.disabled }}"
      when: services.disabled is defined
      ignore_errors: yes  # Service might not exist

    # ========================================================================
    # Final Configuration
    # ========================================================================

    - name: Display network configuration
      debug:
        msg:
          - "Hostname: {{ hostname }}"
          - "FQDN: {{ fqdn }}"
          - "IP Address: {{ network.ip_address }}/{{ network.netmask }}"
          - "Gateway: {{ network.gateway }}"
          - "DNS Servers: {{ network.dns_servers }}"

  handlers:
    - name: Restart SSH
      systemd:
        name: sshd
        state: restarted
