---
################################################################################
# Playbook: discover-proxmox-inventory.yml
# Purpose: Discover and document existing Proxmox infrastructure
# Author: SMB Office IT Blueprint Project
# Created: 2025-12-26
# Version: 1.0
#
# Description:
#   Queries Proxmox API to discover and document the current state of:
#   - Nodes and their resource usage
#   - Existing VMs and their configurations
#   - Storage pools and capacity
#   - Network configuration
#   - Resource pools
#   - Users and permissions
#
#   Generates a detailed inventory report that can be used for:
#   - Documentation
#   - Planning infrastructure changes
#   - Baseline before automation
#   - Disaster recovery reference
#
# Usage:
#   ansible-playbook playbooks/discover-proxmox-inventory.yml
#   ansible-playbook playbooks/discover-proxmox-inventory.yml --extra-vars "discovery_mode=all"
#   ansible-playbook playbooks/discover-proxmox-inventory.yml --tags nodes
#   ansible-playbook playbooks/discover-proxmox-inventory.yml --tags storage
#
# Output:
#   - Console output with discovered resources
#   - JSON report: /tmp/proxmox-inventory-<timestamp>.json
#   - Markdown report: /tmp/proxmox-inventory-<timestamp>.md
#
# Tags:
#   - version: Proxmox version info
#   - nodes: Node discovery
#   - vms: VM inventory
#   - storage: Storage pools
#   - network: Network configuration
#   - pools: Resource pools
#   - users: User accounts
#   - report: Generate reports
################################################################################

- name: Discover Proxmox Infrastructure Inventory
  hosts: localhost
  gather_facts: no
  connection: local

  vars:
    timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    report_dir: "/tmp"
    inventory_data: {}
    discovery_mode: "{{ discovery_mode | default('standard') }}"

  tasks:
    # ========================================================================
    # Version Information
    # ========================================================================

    - name: Get Proxmox version information
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/version"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_version
      tags: [always, version]

    - name: Display Proxmox version
      debug:
        msg:
          - "╔════════════════════════════════════════════════════════════╗"
          - "║          PROXMOX INFRASTRUCTURE DISCOVERY                 ║"
          - "╚════════════════════════════════════════════════════════════╝"
          - ""
          - "Proxmox VE Version: {{ pve_version.json.data.version }}"
          - "Release: {{ pve_version.json.data.release }}"
          - "Repository ID: {{ pve_version.json.data.repoid }}"
          - "Discovery Time: {{ ansible_date_time.iso8601 }}"
          - ""
      tags: [always, version]

    # ========================================================================
    # Node Discovery
    # ========================================================================

    - name: Get cluster nodes
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_nodes
      tags: [always, nodes]

    - name: Display node information
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "NODES ({{ pve_nodes.json.data | length }})"
          - "════════════════════════════════════════════════════════════"
          - "{% for node in pve_nodes.json.data %}"
          - "Node: {{ node.node }}"
          - "  Status: {{ node.status }}"
          - "  Type: {{ node.type | default('node') }}"
          - "  CPU Usage: {{ (node.cpu * 100) | round(2) }}% ({{ node.maxcpu }} cores)"
          - "  Memory: {{ (node.mem / 1024 / 1024 / 1024) | round(2) }}GB / {{ (node.maxmem / 1024 / 1024 / 1024) | round(2) }}GB ({{ (node.mem / node.maxmem * 100) | round(1) }}%)"
          - "  Uptime: {{ (node.uptime / 86400) | round(1) }} days"
          - "  Kernel: {{ node.kversion | default('Unknown') }}"
          - "  PVE Version: {{ node.pveversion | default('Unknown') }}"
          - "{% endfor %}"
          - ""
      tags: [always, nodes]

    # ========================================================================
    # VM Discovery
    # ========================================================================

    - name: Get all VMs across all nodes
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ item.node }}/qemu"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_vms_raw
      loop: "{{ pve_nodes.json.data }}"
      loop_control:
        label: "{{ item.node }}"
      tags: [always, vms]

    - name: Flatten VM list
      set_fact:
        all_vms: "{{ pve_vms_raw.results | map(attribute='json.data') | flatten }}"
      tags: [always, vms]

    - name: Display VM inventory
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "VIRTUAL MACHINES ({{ all_vms | length }})"
          - "════════════════════════════════════════════════════════════"
          - "{% if all_vms | length > 0 %}"
          - "{% for vm in all_vms | sort(attribute='vmid') %}"
          - "VM {{ vm.vmid }}: {{ vm.name }}"
          - "  Status: {{ vm.status }}"
          - "  Node: {{ vm.node | default('Unknown') }}"
          - "  CPUs: {{ vm.cpus }}"
          - "  Memory: {{ (vm.maxmem / 1024 / 1024 / 1024) | round(2) }}GB"
          - "  Disk: {{ (vm.maxdisk / 1024 / 1024 / 1024) | round(2) }}GB"
          - "  Uptime: {% if vm.uptime is defined %}{{ (vm.uptime / 3600) | round(1) }} hours{% else %}N/A{% endif %}"
          - "  Template: {{ vm.template | default(0) == 1 }}"
          - "{% endfor %}"
          - "{% else %}"
          - "No VMs found"
          - "{% endif %}"
          - ""
      tags: [always, vms]

    # ========================================================================
    # Detailed VM Configuration (--all mode only)
    # ========================================================================

    - name: Get detailed VM configurations (all mode)
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ item.node | default(proxmox_node) }}/qemu/{{ item.vmid }}/config"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: vm_configs_detailed
      loop: "{{ all_vms }}"
      loop_control:
        label: "VM {{ item.vmid }}: {{ item.name }}"
      when: discovery_mode == 'all' and all_vms | length > 0
      failed_when: false
      tags: [vms]

    - name: Display detailed VM configurations (all mode)
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "DETAILED VM CONFIGURATIONS"
          - "════════════════════════════════════════════════════════════"
          - "{% for result in vm_configs_detailed.results %}"
          - "{% if result.json is defined and result.json.data is defined %}"
          - "VM {{ result.item.vmid }}: {{ result.item.name }}"
          - "  Boot Order: {{ result.json.data.boot | default('default') }}"
          - "  OS Type: {{ result.json.data.ostype | default('other') }}"
          - "  BIOS: {{ result.json.data.bios | default('seabios') }}"
          - "  Machine: {{ result.json.data.machine | default('pc') }}"
          - "{% if result.json.data.sockets is defined %}  Sockets: {{ result.json.data.sockets }}{% endif %}"
          - "{% if result.json.data.cores is defined %}  Cores: {{ result.json.data.cores }}{% endif %}"
          - "{% if result.json.data.numa is defined %}  NUMA: {{ result.json.data.numa }}{% endif %}"
          - "{% if result.json.data.agent is defined %}  QEMU Agent: {{ result.json.data.agent }}{% endif %}"
          - "{% if result.json.data.net0 is defined %}  Network 0: {{ result.json.data.net0 }}{% endif %}"
          - "{% if result.json.data.net1 is defined %}  Network 1: {{ result.json.data.net1 }}{% endif %}"
          - "{% if result.json.data.scsi0 is defined %}  Disk 0: {{ result.json.data.scsi0 }}{% endif %}"
          - "{% if result.json.data.ide2 is defined %}  CD-ROM: {{ result.json.data.ide2 }}{% endif %}"
          - "{% endif %}"
          - "{% endfor %}"
          - ""
      when: discovery_mode == 'all' and vm_configs_detailed.results is defined
      tags: [vms]

    # ========================================================================
    # Storage Discovery
    # ========================================================================

    - name: Get storage configuration
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/storage"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_storage
      tags: [always, storage]

    - name: Get storage status for each pool
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/storage/{{ item.storage }}/status"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_storage_status
      loop: "{{ pve_storage.json.data }}"
      loop_control:
        label: "{{ item.storage }}"
      when: item.enabled | default(1) == 1
      failed_when: false
      tags: [always, storage]

    - name: Display storage information
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "STORAGE POOLS ({{ pve_storage.json.data | length }})"
          - "════════════════════════════════════════════════════════════"
          - "{% for storage in pve_storage.json.data %}"
          - "Storage: {{ storage.storage }}"
          - "  Type: {{ storage.type }}"
          - "  Content: {{ storage.content }}"
          - "  Enabled: {{ storage.enabled | default(1) == 1 }}"
          - "  Shared: {{ storage.shared | default(0) == 1 }}"
          - "{% if storage.path is defined %}  Path: {{ storage.path }}{% endif %}"
          - "{% endfor %}"
          - ""
      tags: [always, storage]

    - name: Display storage capacity details (all mode)
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "STORAGE CAPACITY DETAILS"
          - "════════════════════════════════════════════════════════════"
          - "{% for result in pve_storage_status.results %}"
          - "{% if result.json is defined and result.json.data is defined %}"
          - "{% set data = result.json.data %}"
          - "Storage: {{ result.item.storage }}"
          - "  Type: {{ data.type | default('unknown') }}"
          - "{% if data.total is defined and data.used is defined %}"
          - "  Capacity: {{ (data.used / 1024 / 1024 / 1024) | round(2) }}GB / {{ (data.total / 1024 / 1024 / 1024) | round(2) }}GB ({{ ((data.used / data.total) * 100) | round(1) }}% used)"
          - "  Available: {{ ((data.total - data.used) / 1024 / 1024 / 1024) | round(2) }}GB"
          - "{% endif %}"
          - "  Active: {{ data.active | default(1) == 1 }}"
          - "{% endif %}"
          - "{% endfor %}"
          - ""
      when: discovery_mode == 'all' and pve_storage_status.results is defined
      tags: [storage]

    # ========================================================================
    # Network Discovery
    # ========================================================================

    - name: Get network configuration
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/network"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_network
      tags: [always, network]

    - name: Display network configuration
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "NETWORK INTERFACES ({{ pve_network.json.data | length }})"
          - "════════════════════════════════════════════════════════════"
          - "{% for iface in pve_network.json.data | sort(attribute='iface') %}"
          - "Interface: {{ iface.iface }}"
          - "  Type: {{ iface.type }}"
          - "  Active: {{ iface.active | default(0) == 1 }}"
          - "{% if iface.address is defined %}  IP: {{ iface.address }}{% if iface.netmask is defined %}/{{ iface.netmask }}{% endif %}{% endif %}"
          - "{% if iface.gateway is defined %}  Gateway: {{ iface.gateway }}{% endif %}"
          - "{% if iface.bridge_ports is defined %}  Bridge Ports: {{ iface.bridge_ports }}{% endif %}"
          - "{% if iface.bridge_vlan_aware is defined %}  VLAN Aware: {{ iface.bridge_vlan_aware == 1 }}{% endif %}"
          - "{% endfor %}"
          - ""
      tags: [always, network]

    # ========================================================================
    # Resource Pool Discovery
    # ========================================================================

    - name: Get resource pools
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/pools"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_pools
      tags: [always, pools]

    - name: Display resource pools
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "RESOURCE POOLS ({{ pve_pools.json.data | length }})"
          - "════════════════════════════════════════════════════════════"
          - "{% if pve_pools.json.data | length > 0 %}"
          - "{% for pool in pve_pools.json.data | sort(attribute='poolid') %}"
          - "Pool: {{ pool.poolid }}"
          - "{% if pool.comment is defined %}  Comment: {{ pool.comment }}{% endif %}"
          - "{% if pool.members is defined %}  Members: {{ pool.members | length }}{% endif %}"
          - "{% endfor %}"
          - "{% else %}"
          - "No resource pools defined"
          - "{% endif %}"
          - ""
      tags: [always, pools]

    # ========================================================================
    # User Discovery
    # ========================================================================

    - name: Get user list
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/access/users"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}!{{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
        validate_certs: "{{ proxmox_api_validate_certs }}"
        return_content: yes
      register: pve_users
      tags: [always, users]

    - name: Display user accounts
      debug:
        msg:
          - "════════════════════════════════════════════════════════════"
          - "USER ACCOUNTS ({{ pve_users.json.data | length }})"
          - "════════════════════════════════════════════════════════════"
          - "{% for user in pve_users.json.data | sort(attribute='userid') %}"
          - "User: {{ user.userid }}"
          - "  Enabled: {{ user.enable | default(1) == 1 }}"
          - "{% if user.comment is defined %}  Comment: {{ user.comment }}{% endif %}"
          - "{% if user.email is defined %}  Email: {{ user.email }}{% endif %}"
          - "{% if user.groups is defined %}  Groups: {{ user.groups | join(', ') }}{% endif %}"
          - "{% endfor %}"
          - ""
      tags: [always, users]

    # ========================================================================
    # Generate Reports
    # ========================================================================

    - name: Build inventory data structure
      set_fact:
        inventory_data:
          discovery_time: "{{ ansible_date_time.iso8601 }}"
          discovery_mode: "{{ discovery_mode }}"
          proxmox:
            version: "{{ pve_version.json.data.version }}"
            release: "{{ pve_version.json.data.release }}"
            repoid: "{{ pve_version.json.data.repoid }}"
          nodes: "{{ pve_nodes.json.data }}"
          vms: "{{ all_vms }}"
          vm_configs: "{{ vm_configs_detailed.results | default([]) | map(attribute='json.data') | list if discovery_mode == 'all' else [] }}"
          storage: "{{ pve_storage.json.data }}"
          storage_status: "{{ pve_storage_status.results | default([]) | map(attribute='json.data') | list if discovery_mode == 'all' else [] }}"
          network: "{{ pve_network.json.data }}"
          pools: "{{ pve_pools.json.data }}"
          users: "{{ pve_users.json.data }}"
          summary:
            total_nodes: "{{ pve_nodes.json.data | length }}"
            total_vms: "{{ all_vms | length }}"
            running_vms: "{{ all_vms | selectattr('status', 'equalto', 'running') | list | length }}"
            stopped_vms: "{{ all_vms | selectattr('status', 'equalto', 'stopped') | list | length }}"
            templates: "{{ all_vms | selectattr('template', 'defined') | selectattr('template', 'equalto', 1) | list | length }}"
            total_storage: "{{ pve_storage.json.data | length }}"
            total_pools: "{{ pve_pools.json.data | length }}"
            total_users: "{{ pve_users.json.data | length }}"
      tags: [always, report]

    - name: Save inventory as JSON
      copy:
        content: "{{ inventory_data | to_nice_json }}"
        dest: "{{ report_dir }}/proxmox-inventory-{{ timestamp }}.json"
      tags: [always, report]

    - name: Generate Markdown report
      copy:
        content: |
          # Proxmox Infrastructure Inventory Report

          **Generated:** {{ ansible_date_time.iso8601 }}
          **Proxmox Version:** {{ pve_version.json.data.version }} ({{ pve_version.json.data.release }})

          ---

          ## Summary

          | Resource | Count |
          |----------|-------|
          | Nodes | {{ inventory_data.summary.total_nodes }} |
          | Virtual Machines | {{ inventory_data.summary.total_vms }} |
          | - Running | {{ inventory_data.summary.running_vms }} |
          | - Stopped | {{ inventory_data.summary.stopped_vms }} |
          | - Templates | {{ inventory_data.summary.templates }} |
          | Storage Pools | {{ inventory_data.summary.total_storage }} |
          | Resource Pools | {{ inventory_data.summary.total_pools }} |
          | User Accounts | {{ inventory_data.summary.total_users }} |

          ---

          ## Nodes

          {% for node in pve_nodes.json.data %}
          ### {{ node.node }}

          - **Status:** {{ node.status }}
          - **CPU:** {{ (node.cpu * 100) | round(2) }}% ({{ node.maxcpu }} cores)
          - **Memory:** {{ (node.mem / 1024 / 1024 / 1024) | round(2) }}GB / {{ (node.maxmem / 1024 / 1024 / 1024) | round(2) }}GB
          - **Uptime:** {{ (node.uptime / 86400) | round(1) }} days

          {% endfor %}

          ---

          ## Virtual Machines

          {% if all_vms | length > 0 %}
          | VM ID | Name | Status | Node | CPUs | Memory | Disk | Template |
          |-------|------|--------|------|------|--------|------|----------|
          {% for vm in all_vms | sort(attribute='vmid') %}
          | {{ vm.vmid }} | {{ vm.name }} | {{ vm.status }} | {{ vm.node | default('N/A') }} | {{ vm.cpus }} | {{ (vm.maxmem / 1024 / 1024 / 1024) | round(2) }}GB | {{ (vm.maxdisk / 1024 / 1024 / 1024) | round(2) }}GB | {{ vm.template | default(0) == 1 }} |
          {% endfor %}
          {% else %}
          No VMs found.
          {% endif %}

          ---

          ## Storage Pools

          {% for storage in pve_storage.json.data %}
          ### {{ storage.storage }}

          - **Type:** {{ storage.type }}
          - **Content:** {{ storage.content }}
          - **Enabled:** {{ storage.enabled | default(1) == 1 }}
          {% if storage.path is defined %}- **Path:** {{ storage.path }}{% endif %}

          {% endfor %}

          ---

          ## Network Configuration

          {% for iface in pve_network.json.data | sort(attribute='iface') %}
          ### {{ iface.iface }}

          - **Type:** {{ iface.type }}
          - **Active:** {{ iface.active | default(0) == 1 }}
          {% if iface.address is defined %}- **IP:** {{ iface.address }}{% if iface.netmask is defined %}/{{ iface.netmask }}{% endif %}{% endif %}
          {% if iface.bridge_ports is defined %}- **Bridge Ports:** {{ iface.bridge_ports }}{% endif %}
          {% if iface.bridge_vlan_aware is defined %}- **VLAN Aware:** {{ iface.bridge_vlan_aware == 1 }}{% endif %}

          {% endfor %}

          ---

          ## Resource Pools

          {% if pve_pools.json.data | length > 0 %}
          {% for pool in pve_pools.json.data | sort(attribute='poolid') %}
          ### {{ pool.poolid }}

          {% if pool.comment is defined %}- **Comment:** {{ pool.comment }}{% endif %}
          {% if pool.members is defined %}- **Members:** {{ pool.members | length }}{% endif %}

          {% endfor %}
          {% else %}
          No resource pools defined.
          {% endif %}

          ---

          **End of Report**
        dest: "{{ report_dir }}/proxmox-inventory-{{ timestamp }}.md"
      tags: [always, report]

    - name: Display final summary
      debug:
        msg:
          - ""
          - "╔════════════════════════════════════════════════════════════╗"
          - "║              DISCOVERY COMPLETE                           ║"
          - "╚════════════════════════════════════════════════════════════╝"
          - ""
          - "Summary:"
          - "  Nodes: {{ inventory_data.summary.total_nodes }}"
          - "  VMs: {{ inventory_data.summary.total_vms }} ({{ inventory_data.summary.running_vms }} running, {{ inventory_data.summary.stopped_vms }} stopped)"
          - "  Templates: {{ inventory_data.summary.templates }}"
          - "  Storage Pools: {{ inventory_data.summary.total_storage }}"
          - "  Resource Pools: {{ inventory_data.summary.total_pools }}"
          - "  User Accounts: {{ inventory_data.summary.total_users }}"
          - ""
          - "Reports saved:"
          - "  JSON: {{ report_dir }}/proxmox-inventory-{{ timestamp }}.json"
          - "  Markdown: {{ report_dir }}/proxmox-inventory-{{ timestamp }}.md"
          - ""
      tags: [always, report]
